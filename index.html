<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì •ì‚° ë¶„ë¦¬íˆ´</title>

  <!-- SheetJS + JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root {
      --bg:#0b0f17; --card:#121a27; --line:#223044;
      --text:#e8eef8; --muted:#a8b3c7;
      --btn:#2b66ff; --btn2:#1c2a3f; --bad:#ff4d4d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif;
      background:linear-gradient(180deg,#070a10,#0b0f17);
      color:var(--text)
    }
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px 48px}
    .card{
      background:rgba(18,26,39,.95);
      border:1px solid var(--line);
      border-radius:14px;
      padding:18px 16px;
      box-shadow:0 12px 32px rgba(0,0,0,.25)
    }
    h1{font-size:18px;margin:0 0 14px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input{
      background:#0e1522;border:1px solid var(--line);color:var(--text);
      padding:10px;border-radius:10px;outline:none;min-width:140px
    }
    input[type="file"]{color:var(--muted)}
    button{
      border:0;border-radius:10px;padding:10px 12px;
      font-weight:700;color:white;background:var(--btn);cursor:pointer
    }
    button.secondary{
      background:var(--btn2);color:var(--text);border:1px solid var(--line)
    }
    button:disabled{opacity:.5;cursor:not-allowed}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:860px){.split{grid-template-columns:1.1fr .9fr}}
    .box{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0e1522}
    .groupList{max-height:360px;overflow:auto}
    .gitem{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px dashed #223044}
    .gitem:last-child{border-bottom:none}
    .badge{font-size:12px;color:var(--muted)}
    .err{color:var(--bad);font-weight:700}
    .ok{color:#7CFFAE;font-weight:700}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .hr{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOCK -->
  <div id="lock" class="card">
    <div class="topbar">
      <h1>ì •ì‚° ë¶„ë¦¬íˆ´ ğŸ”</h1>
      <div class="badge">ì ‘ê·¼ ì œí•œ</div>
    </div>

    <div class="row">
      <div class="field">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      </div>
      <button id="enterBtn">ì…ì¥</button>
    </div>

    <div id="lockMsg" class="err" style="margin-top:10px"></div>
  </div>

  <!-- APP -->
  <div id="app" class="card" style="display:none">
    <div class="topbar">
      <h1>ì •ì‚°ë¦¬ìŠ¤íŠ¸ ê·¸ë£¹ ë¶„ë¦¬ ğŸ§¾</h1>
      <div class="badge" id="status">ëŒ€ê¸°</div>
    </div>

    <div class="split">
      <div class="box">
        <div class="row">
          <div class="field">
            <label>ì›”</label>
            <input id="month" value="11ì›”" />
          </div>
          <div class="field">
            <label>ì–‘ì‹ ë í–‰</label>
            <input id="headerEnd" type="number" value="9" />
          </div>
          <div class="field">
            <label>ë°ì´í„° ì‹œì‘ í–‰</label>
            <input id="dataStart" type="number" value="10" />
          </div>
          <div class="field">
            <label>ì—´ ì‹œì‘</label>
            <input id="colStart" value="A" />
          </div>
          <div class="field">
            <label>ì—´ ë</label>
            <input id="colEnd" value="CD" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <input id="file" type="file" accept=".xlsx" />
          <button id="scanBtn" class="secondary" disabled>ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="zipBtn" disabled>ZIP ìƒì„±</button>
        </div>

        <div id="appMsg" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="box">
        <div class="row" style="justify-content:space-between">
          <div>
            <b>ê·¸ë£¹ ì„ íƒ</b>
            <div id="groupCount" class="muted">ì—…ë¡œë“œ í•„ìš”</div>
          </div>
          <div class="row">
            <button id="allOn" class="secondary" disabled>ì „ì²´ì„ íƒ</button>
            <button id="allOff" class="secondary" disabled>ì „ì²´í•´ì œ</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="groups" class="groupList"></div>
      </div>
    </div>
  </div>

</div>

<script>
/* ===== ë¹„ë°€ë²ˆí˜¸ (ì§ì ‘ ë¹„êµ) ===== */
const PASSWORD = "ss315696ss";
const FIXED_SHEET = "ì •ì‚°ë¦¬ìŠ¤íŠ¸";
const GROUP_COL = "B";
const $ = id => document.getElementById(id);

$("enterBtn").onclick = () => {
  $("lockMsg").textContent = "";
  if ($("pw").value !== PASSWORD) {
    $("lockMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
    return;
  }
  $("lock").style.display = "none";
  $("app").style.display = "block";
};

$("pw").addEventListener("keydown", e => {
  if (e.key === "Enter") $("enterBtn").click();
});

/* ===== Excel ì²˜ë¦¬ ===== */
let workbook, sheet, groupsMap = new Map();

function colToIdx(c){
  let n=0; c=c.toUpperCase();
  for(let i=0;i<c.length;i++) n=n*26+(c.charCodeAt(i)-64);
  return n;
}
function addr(c,r){
  let s=""; while(c){let m=(c-1)%26;s=String.fromCharCode(65+m)+s;c=(c-1)/26|0}
  return s+r;
}

$("file").onchange = () => {
  $("scanBtn").disabled = !$("file").files[0];
};

$("scanBtn").onclick = async () => {
  const f = $("file").files[0];
  const ab = await f.arrayBuffer();
  workbook = XLSX.read(ab, {type:"array", cellStyles:true});
  sheet = workbook.Sheets[FIXED_SHEET];
  if (!sheet) { alert("ì •ì‚°ë¦¬ìŠ¤íŠ¸ ì‹œíŠ¸ ì—†ìŒ"); return; }

  groupsMap.clear();
  const start = +$("dataStart").value;
  const gcol = colToIdx(GROUP_COL);
  const range = XLSX.utils.decode_range(sheet["!ref"]);

  for(let r=start;r<=range.e.r+1;r++){
    const v = sheet[addr(gcol,r)]?.v;
    if(!v) continue;
    if(!groupsMap.has(v)) groupsMap.set(v,[]);
    groupsMap.get(v).push(r);
  }

  const root = $("groups"); root.innerHTML="";
  [...groupsMap.keys()].sort().forEach(g=>{
    root.innerHTML += `<div class="gitem">
      <input type="checkbox" checked data-g="${g}"/> ${g}
    </div>`;
  });

  $("groupCount").textContent = `ì´ ${groupsMap.size}ê°œ`;
  $("zipBtn").disabled = false;
  $("allOn").disabled = false;
  $("allOff").disabled = false;
};

$("allOn").onclick = ()=>document.querySelectorAll("#groups input").forEach(x=>x.checked=true);
$("allOff").onclick = ()=>document.querySelectorAll("#groups input").forEach(x=>x.checked=false);

$("zipBtn").onclick = async () => {
  const zip = new JSZip();
  const month = $("month").value;
  const hEnd = +$("headerEnd").value;
  const dStart = +$("dataStart").value;
  const cS = colToIdx($("colStart").value);
  const cE = colToIdx($("colEnd").value);

  document.querySelectorAll("#groups input:checked").forEach(cb=>{
    const g = cb.dataset.g;
    const rows = groupsMap.get(g);
    const out = {};

    for(let r=1;r<=hEnd;r++)
      for(let c=cS;c<=cE;c++)
        if(sheet[addr(c,r)])
          out[addr(c-cS+1,r)] = {...sheet[addr(c,r)]};

    let rr=dStart;
    rows.forEach(sr=>{
      for(let c=cS;c<=cE;c++)
        if(sheet[addr(c,sr)])
          out[addr(c-cS+1,rr)] = {...sheet[addr(c,sr)]};
      rr++;
    });

    out["!ref"] = XLSX.utils.encode_range({
      s:{c:0,r:0},
      e:{c:cE-cS,r:rr-1}
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,out,FIXED_SHEET);
    zip.file(`${month} (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_${g}.xlsx`,
      XLSX.write(wb,{type:"array",bookType:"xlsx"}));
  });

  const blob = await zip.generateAsync({type:"blob"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`${$("month").value} (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_ì •ì‚°ì„œ.zip`;
  a.click();
};
</script>
</body>
</html>
