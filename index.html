<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì •ì‚° ë¶„ë¦¬íˆ´</title>

  <!-- xlsx-js-style (ìŠ¤íƒ€ì¼ ì €ì¥) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <!-- JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root { --line:#223044; --text:#e8eef8; --muted:#a8b3c7; --btn:#2b66ff; --btn2:#1c2a3f; --bad:#ff4d4d; --ok:#7CFFAE; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif;background:linear-gradient(180deg,#070a10,#0b0f17);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px 48px}
    .card{background:rgba(18,26,39,.95);border:1px solid var(--line);border-radius:14px;padding:18px 16px;box-shadow:0 12px 32px rgba(0,0,0,.25)}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input{background:#0e1522;border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px;outline:none;min-width:140px}
    input[type="file"]{color:var(--muted)}
    button{border:0;border-radius:10px;padding:10px 12px;font-weight:800;color:white;background:var(--btn);cursor:pointer;transition:transform .06s ease, filter .12s ease, opacity .12s ease}
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px); filter:brightness(.98)}
    button.secondary{background:var(--btn2);color:var(--text);border:1px solid var(--line)}
    button:disabled{opacity:.45;cursor:not-allowed;transform:none;filter:none}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:860px){.split{grid-template-columns:1.1fr .9fr}}
    .box{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0e1522}
    .groupList{max-height:360px;overflow:auto}
    .gitem{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px dashed rgba(34,48,68,.7)}
    .gitem:last-child{border-bottom:none}
    .err{color:var(--bad);font-weight:800}
    .ok{color:var(--ok);font-weight:800}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .spinner{width:18px;height:18px;border-radius:50%;border:2px solid rgba(168,179,199,.35);border-top-color: rgba(232,238,248,.9);animation:spin .75s linear infinite}
    @keyframes spin { to { transform: rotate(360deg); } }
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(14,21,34,.8);color:var(--muted);font-size:12px}
    .chk{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:rgba(14,21,34,.75)}
    .chk input{min-width:auto}
  </style>
</head>

<body>
<div class="wrap">

  <div id="lock" class="card">
    <div class="topbar">
      <h1>ì •ì‚° ë¶„ë¦¬íˆ´ ğŸ”</h1>
      <div class="muted">ì ‘ê·¼ ì œí•œ</div>
    </div>
    <div class="row">
      <div class="field">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      </div>
      <button id="enterBtn">ì…ì¥</button>
    </div>
    <div id="lockMsg" class="err" style="margin-top:10px"></div>
    <div id="libMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <div id="app" class="card" style="display:none">
    <div class="topbar">
      <h1>ì •ì‚°ë¦¬ìŠ¤íŠ¸ ê·¸ë£¹ ë¶„ë¦¬ ğŸ§¾</h1>
      <div class="pill"><span id="spin" class="spinner" style="display:none"></span><span id="status">ëŒ€ê¸°</span></div>
    </div>

    <div class="split">
      <div class="box">
        <div class="row">
          <div class="field"><label>ì›”</label><input id="month" value="11ì›”" /></div>
          <div class="field"><label>ì–‘ì‹ ë í–‰</label><input id="headerEnd" type="number" value="9" min="1" /></div>
          <div class="field"><label>ë°ì´í„° ì‹œì‘ í–‰</label><input id="dataStart" type="number" value="10" min="1" /></div>
          <div class="field"><label>ì—´ ì‹œì‘</label><input id="colStart" value="A" /></div>
          <div class="field"><label>ì—´ ë</label><input id="colEnd" value="AZ" /></div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="field" style="min-width:260px">
            <label>ì •ì‚° ì—‘ì…€ ì—…ë¡œë“œ (.xlsx)</label>
            <input id="file" type="file" accept=".xlsx" />
          </div>
          <button id="scanBtn" class="secondary" disabled>ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="zipBtn" disabled>ZIP ìƒì„±</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="chk">
            <input id="sooseokStyle" type="checkbox" checked />
            <label for="sooseokStyle" style="margin:0">ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤ í…œí”Œë¦¿ ì„œì‹ ì ìš©(ë³‘í•©/í…Œë‘ë¦¬/ìŒì˜)</label>
          </div>
          <div class="chk">
            <input id="valueOnly" type="checkbox" checked />
            <label for="valueOnly" style="margin:0">ìˆ˜ì‹ ì œê±°í•˜ê³  ê°’ë§Œ ì €ì¥</label>
          </div>
        </div>

        <div id="appMsg" class="muted" style="margin-top:10px"></div>
        <div class="muted" style="margin-top:6px">
          í–‰ë†’ì´: <b>ì „ë¶€ 20</b> / í™•ëŒ€: <b>70%</b> / ëˆˆê¸ˆì„ : <b>OFF</b><br/>
          ë°©ì‹: ì„ íƒ ê·¸ë£¹ í–‰ë§Œ ë½‘ì•„ <b>ìƒˆ íŒŒì¼ ìƒì„±</b>
        </div>
      </div>

      <div class="box">
        <div class="row" style="justify-content:space-between">
          <div>
            <b>ê·¸ë£¹ ì„ íƒ</b>
            <div id="groupCount" class="muted">ì—…ë¡œë“œ í›„ ê·¸ë£¹ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</div>
          </div>
          <div class="row">
            <button id="allOn" class="secondary" disabled>ì „ì²´ì„ íƒ</button>
            <button id="allOff" class="secondary" disabled>ì „ì²´í•´ì œ</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="groups" class="groupList"></div>
      </div>
    </div>
  </div>

</div>

<script>
const PASSWORD = "ss315696ss";
const FIXED_SHEET = "ì •ì‚°ë¦¬ìŠ¤íŠ¸";
const GROUP_COL = "B";
const $ = id => document.getElementById(id);

function setLoading(on, text){
  $("spin").style.display = on ? "inline-block" : "none";
  $("status").textContent = text || (on ? "ì²˜ë¦¬ì¤‘" : "ëŒ€ê¸°");
}
function msg(html, isErr=false){
  $("appMsg").innerHTML = isErr ? `<span class="err">${html}</span>` : html;
}

(function(){
  const ok = (typeof XLSX !== "undefined") && (typeof JSZip !== "undefined");
  $("libMsg").innerHTML = ok ? `<span class="ok">ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ</span>` : `<span class="err">ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨)</span>`;
})();

$("enterBtn").onclick = () => {
  $("lockMsg").textContent = "";
  if ($("pw").value !== PASSWORD) { $("lockMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."; return; }
  $("lock").style.display = "none";
  $("app").style.display = "block";
  setLoading(false, "ëŒ€ê¸°");
};
$("pw").addEventListener("keydown", e => { if(e.key==="Enter") $("enterBtn").click(); });

let workbook=null, sheet=null, groupsMap=new Map();

function colToIdx(c){
  let n=0; c=String(c||"").toUpperCase().trim();
  if(!/^[A-Z]+$/.test(c)) return null;
  for(let i=0;i<c.length;i++) n=n*26+(c.charCodeAt(i)-64);
  return n;
}
function idxToCol(n){ let s=""; while(n){let m=(n-1)%26; s=String.fromCharCode(65+m)+s; n=((n-1)/26)|0} return s; }
function A(c,r){ return idxToCol(c)+r; }

function validate(){
  const month = $("month").value.trim();
  const hEnd = Number($("headerEnd").value);
  const dStart = Number($("dataStart").value);
  const cS = colToIdx($("colStart").value);
  const cE = colToIdx($("colEnd").value);
  const errs=[];
  if(!month) errs.push("ì›”ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
  if(!Number.isFinite(hEnd)||hEnd<1) errs.push("ì–‘ì‹ ë í–‰ì´ ì´ìƒí•©ë‹ˆë‹¤.");
  if(!Number.isFinite(dStart)||dStart<1) errs.push("ë°ì´í„° ì‹œì‘ í–‰ì´ ì´ìƒí•©ë‹ˆë‹¤.");
  if(Number.isFinite(hEnd)&&Number.isFinite(dStart)&&hEnd>=dStart) errs.push("ì–‘ì‹ ë í–‰ì€ ë°ì´í„° ì‹œì‘ í–‰ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.");
  if(!cS) errs.push("ì—´ ì‹œì‘ì´ ì´ìƒí•©ë‹ˆë‹¤. ì˜ˆ: A");
  if(!cE) errs.push("ì—´ ëì´ ì´ìƒí•©ë‹ˆë‹¤. ì˜ˆ: AZ");
  if(cS&&cE&&cS>cE) errs.push("ì—´ ì‹œì‘ì´ ì—´ ëë³´ë‹¤ ë’¤ì…ë‹ˆë‹¤.");
  return {month,hEnd,dStart,cS,cE,errs};
}

function renderGroups(){
  const root=$("groups"); root.innerHTML="";
  const keys=[...groupsMap.keys()].sort((a,b)=>String(a).localeCompare(String(b),"ko"));
  for(const g of keys){
    const div=document.createElement("div");
    div.className="gitem";
    div.innerHTML=`<input type="checkbox" checked data-g="${encodeURIComponent(g)}"/><span>${g}</span>`;
    root.appendChild(div);
  }
  $("groupCount").textContent=`ê·¸ë£¹ ${keys.length}ê°œ`;
}

$("file").onchange=()=>{
  const ok=!!$("file").files?.[0];
  $("scanBtn").disabled=!ok;
  $("zipBtn").disabled=true;
  $("allOn").disabled=true;
  $("allOff").disabled=true;
  $("groups").innerHTML="";
  $("groupCount").textContent="ì—…ë¡œë“œ í›„ ê·¸ë£¹ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.";
  msg("");
  workbook=null; sheet=null; groupsMap=new Map();
};

$("allOn").onclick=()=>document.querySelectorAll("#groups input[type=checkbox]").forEach(x=>x.checked=true);
$("allOff").onclick=()=>document.querySelectorAll("#groups input[type=checkbox]").forEach(x=>x.checked=false);

$("scanBtn").onclick=async()=>{
  const f=$("file").files?.[0]; if(!f) return;
  const v=validate(); if(v.errs.length){ msg(v.errs.join(" "), true); return; }

  try{
    setLoading(true, "ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘");
    $("scanBtn").disabled=true;
    $("zipBtn").disabled=true;
    $("allOn").disabled=true;
    $("allOff").disabled=true;
    $("groups").innerHTML=`<div class="row"><span class="spinner"></span><span class="muted">ë¡œë”©ì¤‘...</span></div>`;

    const ab=await f.arrayBuffer();
    workbook = XLSX.read(ab, {type:"array", cellStyles:true, cellNF:true, cellText:false});
    sheet = workbook.Sheets[FIXED_SHEET];
    if(!sheet){ msg(`'${FIXED_SHEET}' ì‹œíŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`, true); setLoading(false,"ì˜¤ë¥˜"); return; }

    groupsMap.clear();
    const gcol=colToIdx(GROUP_COL);
    const range=XLSX.utils.decode_range(sheet["!ref"]);
    for(let r=v.dStart; r<=range.e.r+1; r++){
      const cell = sheet[A(gcol,r)];
      const gv = cell ? String(cell.v ?? "").trim() : "";
      if(!gv) continue;
      if(!groupsMap.has(gv)) groupsMap.set(gv, []);
      groupsMap.get(gv).push(r);
    }

    renderGroups();
    const has=groupsMap.size>0;
    $("zipBtn").disabled=!has;
    $("allOn").disabled=!has;
    $("allOff").disabled=!has;
    msg(has ? `<span class="ok">ê·¸ë£¹ ë¡œë“œ ì™„ë£Œ</span>` : `<span class="err">ê·¸ë£¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`, !has);
    setLoading(false, has ? "ëŒ€ê¸°" : "ì˜¤ë¥˜");
  }catch(e){
    console.error(e);
    msg("ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)", true);
    setLoading(false, "ì˜¤ë¥˜");
  }finally{
    $("scanBtn").disabled=false;
  }
};

function safeFilePart(s){
  return String(s ?? "").trim()
    .replace(/[\\\/:*?"<>|]/g, "_")
    .replace(/\s+/g, " ")
    .trim() || "ê·¸ë£¹ì—†ìŒ";
}

/* ===== ê°’ë§Œ ë‚¨ê¸°ê¸°(ìˆ˜ì‹ ì œê±°) ===== */
function valueOnlyCell(sc){
  if(!sc) return null;
  let v = sc.v;
  let t = sc.t;
  let z = sc.z;

  if (v === undefined || v === null) {
    if (sc.w != null && String(sc.w).length) { v = String(sc.w); t = "s"; }
    else return null;
  }
  const out = { t, v };
  if (z !== undefined) out.z = z;
  return out;
}
function copyValue(srcSheet, dstSheet, sAddr, dAddr){
  const sc = srcSheet[sAddr];
  if(!sc) return;
  const c = valueOnlyCell(sc);
  if(!c) return;
  dstSheet[dAddr] = c;
}

/* ===== ìŠ¤íƒ€ì¼ í—¬í¼ ===== */
function border(style="thin", rgb="000000"){
  const c = {rgb};
  return { top:{style,color:c}, bottom:{style,color:c}, left:{style,color:c}, right:{style,color:c} };
}
const FONT10 = {name:"ë§‘ì€ ê³ ë”•", sz:10};
const FONT11B = {name:"ë§‘ì€ ê³ ë”•", sz:11, bold:true};
const FONT14B = {name:"ë§‘ì€ ê³ ë”•", sz:14, bold:true};

function fill(rgb){ return {patternType:"solid", fgColor:{rgb}}; }

function styleBase({bold=false, sz=10, align="center", fillRgb=null, bStyle="thin"}={}){
  const s = {
    font: {name:"ë§‘ì€ ê³ ë”•", sz, bold},
    alignment:{ vertical:"center", horizontal:align, wrapText:true },
    border: border(bStyle, "000000")
  };
  if(fillRgb) s.fill = fill(fillRgb);
  return s;
}

function setStyle(sh, a, s){
  if(!sh[a]) return;
  sh[a].s = s;
}

/* ìˆ«ìí‘œì‹œ ìµœëŒ€í•œ ë§ì¶”ê¸° */
function maybeNumberCell(cell){
  if(!cell || cell.v == null) return;
  if (typeof cell.v === "number") { cell.t="n"; cell.z="#,##0"; return; }
  if (typeof cell.v === "string") {
    const s = cell.v.replace(/,/g,"").trim();
    if (/^-?\d+(\.\d+)?$/.test(s) && s.length <= 15) {
      const n = Number(s);
      if (Number.isFinite(n)) { cell.v=n; cell.t="n"; cell.z="#,##0"; }
    }
  }
}

/* ===== í…œí”Œë¦¿ ë³‘í•©/ì„œì‹ ì ìš© (A~AZ ê¸°ì¤€ ìµœëŒ€ í¡ì‚¬) ===== */
function applySooseokTemplate(ws, colCount, headerEnd, dataStart, lastRow){
  // 1) ê¸°ë³¸: í–‰ë†’ì´ 20
  ws["!rows"] = Array.from({length:lastRow}, ()=>({hpt:20}));

  // 2) ë³‘í•©(ìŠ¤í¬ë¦°ìƒ· ê¸°ë°˜ â€œê°€ì¥ ë¹„ìŠ·í•˜ê²Œâ€)
  // íƒ€ì´í‹€: (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤ ì •ì‚°ë¦¬ìŠ¤íŠ¸ (ëŒ€ëµ 3í–‰ ì „ì²´)
  ws["!merges"] = ws["!merges"] || [];
  ws["!merges"].push(
    { s:{r:2,c:0}, e:{r:2,c:colCount-1} } // A3:AZ3
  );
  // ë…¸ë€ ë°”(ëŒ€ëµ 5í–‰ ê°€ìš´ë°)
  // F5:O5 ì •ë„ë¡œ í•œ ì¤„ ê°•ì¡°(ë„ˆ íŒŒì¼ì€ ê°€ìš´ë°ì— ë…¸ë€ ë°•ìŠ¤ê°€ ìˆì–´ì„œ â€œì¤‘ì•™ì˜ì—­â€ì„ ì¡ìŒ)
  if(colCount >= 15){
    ws["!merges"].push({ s:{r:4,c:5}, e:{r:4,c:14} }); // F5:O5
  }

  // 3) ìŠ¤íƒ€ì¼ ë¸”ë¡
  const S_TITLE = { font:FONT14B, alignment:{vertical:"center", horizontal:"center"}, border:border("thin","000000") };
  const S_SUB   = { font:FONT11B, alignment:{vertical:"center", horizontal:"center"}, fill:fill("FFFF00"), border:border("thin","000000") };

  // í—¤ë”ì˜ì—­: 1~headerEnd
  const S_H1 = styleBase({bold:true, sz:10, fillRgb:"D9D9D9", bStyle:"thin"}); // ê¸°ë³¸ íšŒìƒ‰
  const S_H2 = styleBase({bold:true, sz:10, fillRgb:"FFFFFF", bStyle:"medium"}); // 9í–‰ì²˜ëŸ¼ í…Œë‘ë¦¬ ë‘ê»ê²Œ

  // ë°ì´í„°ì˜ì—­
  const S_D  = styleBase({bold:false, sz:10, fillRgb:null, bStyle:"thin"});
  const S_D_ALT = styleBase({bold:false, sz:10, fillRgb:"F2F2F2", bStyle:"thin"}); // ì˜…ì€ ìŒì˜

  // ì»¬ëŸ¬ í•˜ì´ë¼ì´íŠ¸(ìŠ¤í¬ë¦°ìƒ· ëŠë‚Œ)
  const S_YELLOW = styleBase({bold:true, sz:10, fillRgb:"FFFF00", bStyle:"thin"});
  const S_ORANGE = styleBase({bold:true, sz:10, fillRgb:"F4B183", bStyle:"thin"});
  const S_CYAN   = styleBase({bold:true, sz:10, fillRgb:"CFE8F3", bStyle:"thin"});
  const S_PURPLE = styleBase({bold:true, sz:10, fillRgb:"D9D2E9", bStyle:"thin"});
  const S_PINK   = styleBase({bold:true, sz:10, fillRgb:"F4CCCC", bStyle:"thin"});

  // íƒ€ì´í‹€/ì„œë¸Œíƒ€ì´í‹€ ì ìš©
  for(let c=1;c<=colCount;c++){
    const aTitle = idxToCol(c) + 3;
    if(ws[aTitle]) setStyle(ws, aTitle, S_TITLE);

    const aSub = idxToCol(c) + 5;
    // ì¤‘ì•™ ë…¸ë€ ë°” ì˜ì—­ì—ë§Œ ì ìš©
    if(c>=6 && c<=15 && ws[aSub]) setStyle(ws, aSub, S_SUB);
  }

  // í—¤ë” ì ìš© (1~headerEnd)
  for(let r=1;r<=headerEnd;r++){
    for(let c=1;c<=colCount;c++){
      const a = idxToCol(c)+r;
      if(!ws[a]) continue;

      // 9í–‰(ì»¬ëŸ¼ëª… ìˆëŠ” ì¤„)ì„ â€œë‘êº¼ìš´ í…Œë‘ë¦¬ ëŠë‚Œâ€ìœ¼ë¡œ
      if(r === headerEnd) setStyle(ws, a, S_H2);
      else setStyle(ws, a, S_H1);

      // ìŠ¤ìƒ· ëŠë‚Œ ë‚´ëŠ” ì»¬ëŸ¬ í¬ì¸íŠ¸(ëŒ€ëµì ì¸ ì»¬ëŸ¼ êµ¬ê°„)
      // (ì •í™•í•œ ì»¬ëŸ¼ ìœ„ì¹˜ëŠ” íŒŒì¼ë§ˆë‹¤ ì¡°ê¸ˆ ë‹¬ë¼ì„œ â€œêµ¬ê°„ ì»¬ëŸ¬â€ë¡œ í‰ë‚´)
      if(r === headerEnd){
        if(c>=1 && c<=4) setStyle(ws, a, S_YELLOW);   // ì¢Œì¸¡(ì‹ë³„ì˜ì—­) ë…¸ë€
        if(c>=5 && c<=10) setStyle(ws, a, S_ORANGE);  // íŒë§¤/ì •ë³´ ì˜ì—­ ì˜¤ë Œì§€í†¤
        if(c>=11 && c<=18) setStyle(ws, a, S_CYAN);   // ì¤‘ê°„ ì—°íŒŒë‘
        if(c>=19 && c<=26) setStyle(ws, a, S_PURPLE); // ì—°ë³´ë¼
        if(c>=27 && c<=34) setStyle(ws, a, S_PINK);   // ì—°ë¶„í™
      }
    }
  }

  // ë°ì´í„° ì ìš© + ì§ìˆ˜í–‰ ìŒì˜
  for(let r=dataStart;r<=lastRow;r++){
    const alt = ((r-dataStart)%2===1);
    for(let c=1;c<=colCount;c++){
      const a = idxToCol(c)+r;
      if(!ws[a]) continue;
      setStyle(ws, a, alt ? S_D_ALT : S_D);
      maybeNumberCell(ws[a]);
    }
  }

  // 4) ì—´ë„ˆë¹„: ë„ˆë¬´ ìë™ì´ë©´ ê¹¨ì ¸ ë³´ì´ë‹ˆ â€œì ë‹¹íˆ ê³ ì • ëŠë‚Œâ€
  // (ìŠ¤í¬ë¦°ìƒ·ì²˜ëŸ¼ ì¢Œì¸¡ì€ ì¢ê³ , ì¤‘ê°„ í…ìŠ¤íŠ¸ëŠ” ë„“ê³ , ê¸ˆì•¡ì€ ì¤‘ê°„)
  const cols = [];
  for(let c=1;c<=colCount;c++){
    let w = 10;
    if(c<=4) w = 8;
    else if(c<=10) w = 14;
    else if(c<=18) w = 12;
    else if(c<=26) w = 14;
    else if(c<=34) w = 11;
    else w = 10;
    cols.push({wch:w});
  }
  ws["!cols"] = cols;
}

/* workbook view helpers */
function applyWorkbookView(wb){
  // ì¼ë¶€ ì—‘ì…€ ë²„ì „ì—ì„œë§Œ ë°˜ì˜ë  ìˆ˜ ìˆìŒ(ê°€ëŠ¥í•œ ìµœëŒ€ì¹˜ë¡œ ì„¤ì •)
  wb.Workbook = wb.Workbook || {};
  wb.Workbook.Views = wb.Workbook.Views || [{}];
  wb.Workbook.Views[0].zoom = 70;
  wb.Workbook.Views[0].showGridLines = 0;
}

$("zipBtn").onclick=async()=>{
  const v=validate();
  if(v.errs.length){ msg(v.errs.join(" "), true); return; }
  if(!sheet || groupsMap.size===0){ msg("ë¨¼ì € ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.", true); return; }

  const selected=[...document.querySelectorAll("#groups input[type=checkbox]:checked")]
    .map(cb=>decodeURIComponent(cb.dataset.g));
  if(selected.length===0){ msg("ì„ íƒëœ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.", true); return; }

  const useTemplate = $("sooseokStyle").checked;
  const valueOnly = $("valueOnly").checked;

  try{
    setLoading(true, "ZIP ìƒì„± ì¤‘");
    $("zipBtn").disabled=true;
    const zip = new JSZip();

    for(let i=0;i<selected.length;i++){
      const group = selected[i];
      const rows = groupsMap.get(group) || [];

      const out = {};
      const outColCount = (v.cE - v.cS + 1);

      // 1) í—¤ë”(1~headerEnd)
      for(let r=1; r<=v.hEnd; r++){
        for(let c=v.cS; c<=v.cE; c++){
          const srcA = A(c,r);
          const dstA = A(c - v.cS + 1, r);
          if(valueOnly) copyValue(sheet, out, srcA, dstA);
          else { const sc = sheet[srcA]; if(sc) out[dstA] = {...sc}; }
        }
      }

      // 2) ë°ì´í„°: ê·¸ë£¹í–‰ë§Œ ì—°ì†
      let rr = v.dStart;
      for(const sr of rows){
        for(let c=v.cS; c<=v.cE; c++){
          const srcA = A(c,sr);
          const dstA = A(c - v.cS + 1, rr);
          if(valueOnly) copyValue(sheet, out, srcA, dstA);
          else { const sc = sheet[srcA]; if(sc) out[dstA] = {...sc}; }
        }
        rr++;
      }

      const outLastRow = Math.max(v.hEnd, rr-1);

      out["!ref"] = XLSX.utils.encode_range({
        s:{c:0,r:0},
        e:{c:outColCount-1, r:outLastRow-1}
      });

      // 3) í…œí”Œë¦¿ ìŠ¤íƒ€ì¼
      if(useTemplate){
        applySooseokTemplate(out, outColCount, v.hEnd, v.dStart, outLastRow);
      }else{
        // ìµœì†Œí•œ í–‰ë†’ì´ë§Œ
        out["!rows"] = Array.from({length:outLastRow}, ()=>({hpt:20}));
      }

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, out, FIXED_SHEET);
      applyWorkbookView(wb);

      const fname = `${v.month} (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_${safeFilePart(group)}.xlsx`;
      const bytes = XLSX.write(wb, { type:"array", bookType:"xlsx", cellStyles:true });
      zip.file(fname, bytes);

      $("status").textContent = `ZIP ìƒì„± ì¤‘ (${i+1}/${selected.length})`;
    }

    const blob = await zip.generateAsync({type:"blob"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`${v.month} (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_ì •ì‚°ì„œ.zip`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);

    msg(`<span class="ok">ZIP ë‹¤ìš´ë¡œë“œ ì‹œì‘</span>`);
    setLoading(false, "ì™„ë£Œ");
  }catch(e){
    console.error(e);
    msg("ZIP ìƒì„± ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)", true);
    setLoading(false, "ì˜¤ë¥˜");
  }finally{
    $("zipBtn").disabled=false;
  }
};
</script>
</body>
</html>
