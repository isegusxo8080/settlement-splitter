<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì •ì‚° ë¶„ë¦¬íˆ´</title>

  <!-- SheetJS + JSZip (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root { --bg:#0b0f17; --card:#121a27; --line:#223044; --text:#e8eef8; --muted:#a8b3c7; --btn:#2b66ff; --btn2:#1c2a3f; --bad:#ff4d4d; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:linear-gradient(180deg,#070a10,#0b0f17);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px 48px}
    .card{background:rgba(18,26,39,.92);border:1px solid var(--line);border-radius:14px;padding:18px 16px;box-shadow:0 12px 32px rgba(0,0,0,.25)}
    h1{font-size:18px;margin:0 0 14px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],input[type="number"],input[type="password"]{
      background:#0e1522;border:1px solid var(--line);color:var(--text);
      padding:10px 10px;border-radius:10px;outline:none;min-width:160px
    }
    input[type="file"]{color:var(--muted)}
    button{
      border:0;border-radius:10px;padding:10px 12px;font-weight:700;
      color:white;background:var(--btn);cursor:pointer
    }
    button.secondary{background:var(--btn2);color:var(--text);border:1px solid var(--line)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .split{display:grid;grid-template-columns: 1fr;gap:12px}
    @media (min-width: 860px){ .split{grid-template-columns: 1.1fr .9fr;} }
    .box{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0e1522}
    .groupList{max-height:360px;overflow:auto;padding-right:6px}
    .gitem{display:flex;align-items:center;gap:10px;padding:8px 6px;border-bottom:1px dashed rgba(34,48,68,.5)}
    .gitem:last-child{border-bottom:none}
    .badge{font-size:12px;color:var(--muted)}
    .err{color:var(--bad);font-weight:700}
    .ok{color:#7CFFAE;font-weight:700}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .tiny{font-size:12px;color:var(--muted);line-height:1.45}
    .hr{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOCK SCREEN -->
    <div id="lock" class="card">
      <div class="topbar">
        <h1>ì •ì‚° ë¶„ë¦¬íˆ´ ğŸ”</h1>
        <div class="badge">Netlify ë°°í¬ìš©</div>
      </div>

      <div class="row">
        <div class="field">
          <label>ë¹„ë°€ë²ˆí˜¸</label>
          <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password" />
        </div>
        <button id="enterBtn">ì…ì¥</button>
      </div>

      <div style="margin-top:10px" class="tiny">
        ë¹„ë²ˆì´ ë§ìœ¼ë©´ ì´ í˜ì´ì§€ê°€ ì •ì‚° ë¶„ë¦¬ í™”ë©´ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.<br/>
        (ì •ì‚° ì—‘ì…€ì€ ì„œë²„ë¡œ ì—…ë¡œë“œë˜ì§€ ì•Šê³  ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì²˜ë¦¬ë˜ë„ë¡ êµ¬ì„±)
      </div>

      <div style="margin-top:10px" id="lockMsg" class="err"></div>
    </div>

    <!-- APP SCREEN -->
    <div id="app" class="card" style="display:none">
      <div class="topbar">
        <h1>ì •ì‚°ë¦¬ìŠ¤íŠ¸ ê·¸ë£¹ë³„ ë¶„ë¦¬ ğŸ§¾</h1>
        <div class="badge" id="status">ëŒ€ê¸°</div>
      </div>

      <div class="split">
        <div class="box">
          <div class="row">
            <div class="field">
              <label>ì›” (íŒŒì¼ëª… ì•)</label>
              <input id="month" type="text" value="11ì›”" />
            </div>
            <div class="field">
              <label>ì–‘ì‹ ë í–‰ (ì˜ˆ: 9)</label>
              <input id="headerEnd" type="number" value="9" min="1" />
            </div>
            <div class="field">
              <label>ë°ì´í„° ì‹œì‘ í–‰ (ì˜ˆ: 10)</label>
              <input id="dataStart" type="number" value="10" min="1" />
            </div>
            <div class="field">
              <label>ì—´ ì‹œì‘ (ì˜ˆ: A)</label>
              <input id="colStart" type="text" value="A" />
            </div>
            <div class="field">
              <label>ì—´ ë (ì˜ˆ: CD)</label>
              <input id="colEnd" type="text" value="CD" />
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field" style="min-width:280px">
              <label>ì •ì‚° ì—‘ì…€ ì—…ë¡œë“œ (.xlsx)</label>
              <input id="file" type="file" accept=".xlsx" />
            </div>
            <button id="scanBtn" class="secondary" disabled>ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button id="zipBtn" disabled>ZIP ìƒì„±</button>
          </div>

          <div style="margin-top:10px" class="tiny">
            ê³ ì •ê°’: ì‹œíŠ¸ëª… <b>ì •ì‚°ë¦¬ìŠ¤íŠ¸</b>, ê·¸ë£¹ì—´ <b>B</b><br/>
            íŒŒì¼ëª…: <b>Nì›” (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_(ê·¸ë£¹ëª…).xlsx</b>
          </div>

          <div style="margin-top:10px" id="appMsg" class="tiny"></div>
        </div>

        <div class="box">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800">ê·¸ë£¹ ì„ íƒ</div>
              <div class="muted" id="groupCount">ì—…ë¡œë“œ í›„ ê·¸ë£¹ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</div>
            </div>
            <div class="row">
              <button id="allOn" class="secondary" disabled>ì „ì²´ì„ íƒ</button>
              <button id="allOff" class="secondary" disabled>ì „ì²´í•´ì œ</button>
            </div>
          </div>

          <div class="hr"></div>

          <div id="groups" class="groupList"></div>
        </div>
      </div>
    </div>

  </div>

<script>
  // ===== Password lock (hash compare) =====
  // sha256("ss315696ss!!") precomputed:
  const PASS_SHA256 = "37ebc014d55d83a763a0a24fedffe06705d4042b8243b1bba45c311d8ab1ea45";

  const $ = (id) => document.getElementById(id);

  function setStatus(text, good=false) {
    const s = $("status");
    s.textContent = text;
    s.className = "badge " + (good ? "ok" : "");
  }

  async function sha256Hex(str) {
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
  }

  $("enterBtn").addEventListener("click", async () => {
    $("lockMsg").textContent = "";
    const pw = $("pw").value ?? "";
    if (!pw.trim()) { $("lockMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜."; return; }

    try {
      const h = await sha256Hex(pw);
      if (h !== PASS_SHA256) { $("lockMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´."; return; }
      $("lock").style.display = "none";
      $("app").style.display = "block";
      setStatus("ëŒ€ê¸°", true);
      $("pw").value = "";
    } catch (e) {
      $("lockMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´.";
    }
  });

  $("pw").addEventListener("keydown", (e) => {
    if (e.key === "Enter") $("enterBtn").click();
  });

  // ===== Excel helpers =====
  const FIXED_SHEET = "ì •ì‚°ë¦¬ìŠ¤íŠ¸";
  const GROUP_COL_LETTER = "B";

  function safeFilePart(s) {
    const t = String(s ?? "").trim();
    if (!t) return "ê·¸ë£¹ì—†ìŒ";
    return t.replace(/[\\\/:*?"<>|]/g, "_").replace(/\s+/g, " ").trim();
  }

  function colLetterToIndex(letter) {
    // A -> 1, Z -> 26, AA -> 27
    const s = String(letter || "").toUpperCase().trim();
    if (!/^[A-Z]+$/.test(s)) return null;
    let n = 0;
    for (let i = 0; i < s.length; i++) n = n * 26 + (s.charCodeAt(i) - 64);
    return n;
  }

  function indexToColLetter(n) {
    let s = "";
    while (n > 0) {
      const r = (n - 1) % 26;
      s = String.fromCharCode(65 + r) + s;
      n = Math.floor((n - 1) / 26);
    }
    return s;
  }

  function addr(c, r) { return indexToColLetter(c) + String(r); }

  function getInputConfig() {
    const month = $("month").value.trim();
    const headerEnd = Number($("headerEnd").value);
    const dataStart = Number($("dataStart").value);
    const cStart = colLetterToIndex($("colStart").value);
    const cEnd = colLetterToIndex($("colEnd").value);

    const errs = [];
    if (!month) errs.push("ì›” ì…ë ¥ì´ ë¹„ì—ˆì–´.");
    if (!Number.isFinite(headerEnd) || headerEnd < 1) errs.push("ì–‘ì‹ ë í–‰ì´ ì´ìƒí•´.");
    if (!Number.isFinite(dataStart) || dataStart < 1) errs.push("ë°ì´í„° ì‹œì‘ í–‰ì´ ì´ìƒí•´.");
    if (Number.isFinite(headerEnd) && Number.isFinite(dataStart) && headerEnd >= dataStart) errs.push("ì–‘ì‹ ë í–‰ì€ ë°ì´í„° ì‹œì‘ í–‰ë³´ë‹¤ ì‘ì•„ì•¼ í•´.");
    if (!cStart) errs.push("ì—´ ì‹œì‘ì´ ì´ìƒí•´. ì˜ˆ: A");
    if (!cEnd) errs.push("ì—´ ëì´ ì´ìƒí•´. ì˜ˆ: CD");
    if (cStart && cEnd && cStart > cEnd) errs.push("ì—´ ì‹œì‘ì´ ì—´ ëë³´ë‹¤ ë’¤ì•¼.");

    return { month, headerEnd, dataStart, cStart, cEnd, errs };
  }

  let gWorkbook = null;
  let gSheet = null;
  let gGroups = [];          // unique group names
  let gGroupRows = new Map(); // group -> array of original row numbers

  function renderGroups(groups) {
    const root = $("groups");
    root.innerHTML = "";
    groups.forEach(g => {
      const id = "g_" + btoa(unescape(encodeURIComponent(g))).replace(/=/g,"");
      const div = document.createElement("div");
      div.className = "gitem";
      div.innerHTML = `
        <input type="checkbox" id="${id}" data-group="${encodeURIComponent(g)}" checked />
        <label for="${id}" style="cursor:pointer">${g}</label>
      `;
      root.appendChild(div);
    });
    $("groupCount").textContent = `ê·¸ë£¹ ${groups.length}ê°œ`;
  }

  function getSelectedGroups() {
    const cbs = $("groups").querySelectorAll('input[type="checkbox"]');
    const out = [];
    cbs.forEach(cb => {
      if (cb.checked) out.push(decodeURIComponent(cb.dataset.group));
    });
    return out;
  }

  function setAllGroups(on) {
    const cbs = $("groups").querySelectorAll('input[type="checkbox"]');
    cbs.forEach(cb => cb.checked = on);
  }

  $("file").addEventListener("change", () => {
    const f = $("file").files?.[0];
    $("scanBtn").disabled = !f;
    $("zipBtn").disabled = true;
    $("allOn").disabled = true;
    $("allOff").disabled = true;
    $("groups").innerHTML = "";
    $("groupCount").textContent = "ì—…ë¡œë“œ í›„ ê·¸ë£¹ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.";
    $("appMsg").textContent = "";
    gWorkbook = null; gSheet = null; gGroups = []; gGroupRows = new Map();
  });

  $("scanBtn").addEventListener("click", async () => {
    $("appMsg").textContent = "";
    const cfg = getInputConfig();
    if (cfg.errs.length) {
      $("appMsg").innerHTML = `<span class="err">${cfg.errs.join(" ")}</span>`;
      return;
    }

    const f = $("file").files?.[0];
    if (!f) return;

    setStatus("ì—‘ì…€ ì½ëŠ” ì¤‘...");
    try {
      const ab = await f.arrayBuffer();
      // cellStyles: true to read styles where possible
      gWorkbook = XLSX.read(ab, { type: "array", cellStyles: true, cellNF: true, cellText: false });
      gSheet = gWorkbook.Sheets[FIXED_SHEET];
      if (!gSheet) {
        setStatus("ì˜¤ë¥˜");
        $("appMsg").innerHTML = `<span class="err">ì‹œíŠ¸ '${FIXED_SHEET}'ë¥¼ ì°¾ì§€ ëª»í–ˆì–´.</span>`;
        return;
      }

      // Determine last row from !ref
      const ref = gSheet["!ref"];
      if (!ref) {
        setStatus("ì˜¤ë¥˜");
        $("appMsg").innerHTML = `<span class="err">ì‹œíŠ¸ ë²”ìœ„ë¥¼ ì½ì§€ ëª»í–ˆì–´.</span>`;
        return;
      }
      const range = XLSX.utils.decode_range(ref);
      const lastRow = range.e.r + 1; // 1-based row
      const groupColIdx = colLetterToIndex(GROUP_COL_LETTER);
      if (!groupColIdx) throw new Error("Bad group col");

      // Build group -> rows map
      gGroupRows = new Map();
      for (let r = cfg.dataStart; r <= lastRow; r++) {
        const a = addr(groupColIdx, r);
        const cell = gSheet[a];
        const gv = cell ? String(cell.v ?? "").trim() : "";
        if (!gv) continue;
        if (!gGroupRows.has(gv)) gGroupRows.set(gv, []);
        gGroupRows.get(gv).push(r);
      }

      gGroups = Array.from(gGroupRows.keys()).sort((a,b)=>a.localeCompare(b, "ko"));
      renderGroups(gGroups);

      $("zipBtn").disabled = gGroups.length === 0;
      $("allOn").disabled = gGroups.length === 0;
      $("allOff").disabled = gGroups.length === 0;
      setStatus("ê·¸ë£¹ ë¡œë“œ ì™„ë£Œ", true);

      if (gGroups.length === 0) {
        $("appMsg").innerHTML = `<span class="err">ë°ì´í„° ì‹œì‘ í–‰ë¶€í„° ê·¸ë£¹(Bì—´)ì´ í•œ ê±´ë„ ì—†ì—ˆì–´.</span>`;
      } else {
        $("appMsg").textContent = `ì—…ë¡œë“œ ì™„ë£Œ. í•„ìš”í•œ ê·¸ë£¹ë§Œ ì²´í¬í•˜ê³  ZIP ìƒì„± ëˆ„ë¥´ë©´ ë¼.`;
      }
    } catch (e) {
      console.error(e);
      setStatus("ì˜¤ë¥˜");
      $("appMsg").innerHTML = `<span class="err">ì—‘ì…€ ì½ê¸° ì‹¤íŒ¨. íŒŒì¼ì´ .xlsx ë§ëŠ”ì§€ í™•ì¸í•´ì¤˜.</span>`;
    }
  });

  $("allOn").addEventListener("click", () => setAllGroups(true));
  $("allOff").addEventListener("click", () => setAllGroups(false));

  function copyCell(srcSheet, dstSheet, srcAddr, dstAddr) {
    const c = srcSheet[srcAddr];
    if (!c) return;
    // shallow copy is fine for SheetJS cell objects
    dstSheet[dstAddr] = Object.assign({}, c);
  }

  function sliceColsMeta(cols, cStart, cEnd) {
    if (!Array.isArray(cols)) return cols;
    const out = [];
    for (let c = cStart; c <= cEnd; c++) out.push(cols[c-1] || {});
    return out;
  }

  function sliceRowsMeta(rows, rStart, rEnd) {
    if (!Array.isArray(rows)) return rows;
    const out = [];
    for (let r = rStart; r <= rEnd; r++) out.push(rows[r-1] || {});
    return out;
  }

  function copyMergesInHeader(srcMerges, headerEnd, cStart, cEnd) {
    if (!Array.isArray(srcMerges)) return [];
    const out = [];
    for (const m of srcMerges) {
      const r1 = m.s.r + 1, r2 = m.e.r + 1;
      const c1 = m.s.c + 1, c2 = m.e.c + 1;
      const withinRows = (r1 >= 1 && r2 <= headerEnd);
      const withinCols = (c1 >= cStart && c2 <= cEnd);
      if (withinRows && withinCols) {
        out.push({
          s: { r: (r1-1), c: (c1 - cStart) },
          e: { r: (r2-1), c: (c2 - cStart) }
        });
      }
    }
    return out;
  }

  $("zipBtn").addEventListener("click", async () => {
    $("appMsg").textContent = "";
    const cfg = getInputConfig();
    if (cfg.errs.length) {
      $("appMsg").innerHTML = `<span class="err">${cfg.errs.join(" ")}</span>`;
      return;
    }
    if (!gWorkbook || !gSheet) {
      $("appMsg").innerHTML = `<span class="err">ë¨¼ì € ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ í•´ì¤˜.</span>`;
      return;
    }

    const selected = getSelectedGroups();
    if (selected.length === 0) {
      $("appMsg").innerHTML = `<span class="err">ì„ íƒëœ ê·¸ë£¹ì´ ì—†ì–´.</span>`;
      return;
    }

    setStatus("ZIP ìƒì„± ì¤‘...");
    $("zipBtn").disabled = true;

    try {
      const zip = new JSZip();

      // source metas
      const srcCols = gSheet["!cols"];
      const srcRows = gSheet["!rows"];
      const srcMerges = gSheet["!merges"];

      // figure out lastRow
      const range = XLSX.utils.decode_range(gSheet["!ref"]);
      const lastRow = range.e.r + 1;

      for (let i = 0; i < selected.length; i++) {
        const group = selected[i];
        const rows = gGroupRows.get(group) || [];

        // destination sheet object
        const outSheet = {};

        // Copy header (1..headerEnd), col slice
        for (let r = 1; r <= cfg.headerEnd; r++) {
          for (let c = cfg.cStart; c <= cfg.cEnd; c++) {
            const srcA = addr(c, r);
            const dstA = addr(c - cfg.cStart + 1, r);
            copyCell(gSheet, outSheet, srcA, dstA);
          }
        }

        // Copy group rows into sequential rows starting at dataStart
        let outR = cfg.dataStart;
        for (const srcR of rows) {
          // ignore if outR exceeds something? Not needed
          for (let c = cfg.cStart; c <= cfg.cEnd; c++) {
            const srcA = addr(c, srcR);
            const dstA = addr(c - cfg.cStart + 1, outR);
            copyCell(gSheet, outSheet, srcA, dstA);
          }
          outR++;
        }

        // set sheet range
        const outLastRow = Math.max(cfg.headerEnd, (cfg.dataStart + rows.length - 1));
        outSheet["!ref"] = XLSX.utils.encode_range({
          s: { c: 0, r: 0 },
          e: { c: (cfg.cEnd - cfg.cStart), r: (outLastRow - 1) }
        });

        // copy metas (best effort)
        outSheet["!cols"] = sliceColsMeta(srcCols, cfg.cStart, cfg.cEnd);
        outSheet["!rows"] = sliceRowsMeta(srcRows, 1, outLastRow);
        outSheet["!merges"] = copyMergesInHeader(srcMerges, cfg.headerEnd, cfg.cStart, cfg.cEnd);

        // create workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, outSheet, FIXED_SHEET);

        const fname = `${cfg.month} (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_${safeFilePart(group)}.xlsx`;
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array", cellStyles: true });

        zip.file(fname, wbout);
        setStatus(`ìƒì„± ì¤‘... (${i+1}/${selected.length})`);
      }

      const zipBlob = await zip.generateAsync({ type: "blob" });
      const zipName = `${cfg.month} (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_ì •ì‚°ì„œ.zip`;

      // download
      const a = document.createElement("a");
      a.href = URL.createObjectURL(zipBlob);
      a.download = zipName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);

      setStatus("ì™„ë£Œ", true);
      $("appMsg").innerHTML = `<span class="ok">ZIP ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ëì–´.</span>`;
    } catch (e) {
      console.error(e);
      setStatus("ì˜¤ë¥˜");
      $("appMsg").innerHTML = `<span class="err">ZIP ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´. (ì½˜ì†” ë¡œê·¸ í™•ì¸)</span>`;
    } finally {
      $("zipBtn").disabled = false;
    }
  });
</script>
</body>
</html>
