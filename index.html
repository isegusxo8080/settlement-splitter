<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì •ì‚° ë¶„ë¦¬íˆ´</title>

  <!-- SheetJS (official CDN) + shim -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/shim.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <!-- JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root {
      --bg:#0b0f17; --card:#121a27; --line:#223044;
      --text:#e8eef8; --muted:#a8b3c7;
      --btn:#2b66ff; --btn2:#1c2a3f; --bad:#ff4d4d; --ok:#7CFFAE;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif;
      background:linear-gradient(180deg,#070a10,#0b0f17);
      color:var(--text)
    }
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px 48px}
    .card{
      background:rgba(18,26,39,.95);
      border:1px solid var(--line);
      border-radius:14px;
      padding:18px 16px;
      box-shadow:0 12px 32px rgba(0,0,0,.25)
    }
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input{
      background:#0e1522;border:1px solid var(--line);color:var(--text);
      padding:10px;border-radius:10px;outline:none;min-width:140px
    }
    input[type="file"]{color:var(--muted)}
    button{
      border:0;border-radius:10px;padding:10px 12px;
      font-weight:800;color:white;background:var(--btn);
      cursor:pointer;
      transition:transform .06s ease, filter .12s ease, opacity .12s ease;
      box-shadow:0 10px 22px rgba(43,102,255,.16);
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px); filter:brightness(.98)}
    button.secondary{
      background:var(--btn2);color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }
    button:disabled{opacity:.45;cursor:not-allowed;transform:none;filter:none}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:860px){.split{grid-template-columns:1.1fr .9fr}}
    .box{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0e1522}
    .groupList{max-height:360px;overflow:auto}
    .gitem{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px dashed rgba(34,48,68,.7)}
    .gitem:last-child{border-bottom:none}
    .badge{font-size:12px;color:var(--muted)}
    .err{color:var(--bad);font-weight:800}
    .ok{color:var(--ok);font-weight:800}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .hr{height:1px;background:var(--line);margin:12px 0}

    /* loader */
    .loaderWrap{display:flex;gap:10px;align-items:center;padding:10px 0}
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:2px solid rgba(168,179,199,.35);
      border-top-color: rgba(232,238,248,.9);
      animation:spin .75s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(14,21,34,.8);
      color:var(--muted); font-size:12px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOCK -->
  <div id="lock" class="card">
    <div class="topbar">
      <h1>ì •ì‚° ë¶„ë¦¬íˆ´ ğŸ”</h1>
      <div class="badge">ì ‘ê·¼ ì œí•œ</div>
    </div>

    <div class="row">
      <div class="field">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      </div>
      <button id="enterBtn">ì…ì¥</button>
    </div>

    <div id="lockMsg" class="err" style="margin-top:10px"></div>
    <div id="libMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- APP -->
  <div id="app" class="card" style="display:none">
    <div class="topbar">
      <h1>ì •ì‚°ë¦¬ìŠ¤íŠ¸ ê·¸ë£¹ ë¶„ë¦¬ ğŸ§¾</h1>
      <div class="pill" id="statusPill"><span class="spinner" style="display:none"></span><span id="status">ëŒ€ê¸°</span></div>
    </div>

    <div class="split">
      <div class="box">
        <div class="row">
          <div class="field">
            <label>ì›” (ì˜ˆ: 11ì›”)</label>
            <input id="month" value="11ì›”" />
          </div>
          <div class="field">
            <label>ì–‘ì‹ ë í–‰</label>
            <input id="headerEnd" type="number" value="9" min="1" />
          </div>
          <div class="field">
            <label>ë°ì´í„° ì‹œì‘ í–‰</label>
            <input id="dataStart" type="number" value="10" min="1" />
          </div>
          <div class="field">
            <label>ì—´ ì‹œì‘</label>
            <input id="colStart" value="A" />
          </div>
          <div class="field">
            <label>ì—´ ë</label>
            <input id="colEnd" value="CD" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="field" style="min-width:260px">
            <label>ì •ì‚° ì—‘ì…€ ì—…ë¡œë“œ (.xlsx)</label>
            <input id="file" type="file" accept=".xlsx" />
          </div>
          <button id="scanBtn" class="secondary" disabled>ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="zipBtn" disabled>ZIP ìƒì„±</button>
        </div>

        <div id="appMsg" class="muted" style="margin-top:10px"></div>
        <div class="muted" style="margin-top:6px">
          ê³ ì •ê°’: ì‹œíŠ¸ëª… <b>ì •ì‚°ë¦¬ìŠ¤íŠ¸</b>, ê·¸ë£¹ì—´ <b>B</b> / íŒŒì¼ëª…: <b>Nì›” (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_(ê·¸ë£¹ëª…).xlsx</b>
        </div>
      </div>

      <div class="box">
        <div class="row" style="justify-content:space-between">
          <div>
            <b>ê·¸ë£¹ ì„ íƒ</b>
            <div id="groupCount" class="muted">ì—…ë¡œë“œ í›„ ê·¸ë£¹ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</div>
          </div>
          <div class="row">
            <button id="allOn" class="secondary" disabled>ì „ì²´ì„ íƒ</button>
            <button id="allOff" class="secondary" disabled>ì „ì²´í•´ì œ</button>
          </div>
        </div>
        <div class="hr"></div>

        <div id="groups" class="groupList"></div>
      </div>
    </div>
  </div>

</div>

<script>
/* ===== ì„¤ì • ===== */
const PASSWORD = "ss315696ss";
const FIXED_SHEET = "ì •ì‚°ë¦¬ìŠ¤íŠ¸";
const GROUP_COL = "B";
const $ = id => document.getElementById(id);

/* ===== ìƒíƒœ/ë¡œë”© í‘œì‹œ ===== */
function setLoading(on, text){
  const sp = $("statusPill").querySelector(".spinner");
  sp.style.display = on ? "inline-block" : "none";
  $("status").textContent = text || (on ? "ì²˜ë¦¬ì¤‘" : "ëŒ€ê¸°");
}
function showMsg(html, isErr=false){
  $("appMsg").innerHTML = isErr ? `<span class="err">${html}</span>` : html;
}

/* ===== ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì²´í¬ ===== */
(function checkLibs(){
  const ok = (typeof XLSX !== "undefined") && (typeof JSZip !== "undefined");
  $("libMsg").innerHTML = ok
    ? `<span class="ok">ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ</span>`
    : `<span class="err">ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨(F5) í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜.</span>`;
})();

/* ===== ë¹„ë°€ë²ˆí˜¸ ===== */
$("enterBtn").onclick = () => {
  $("lockMsg").textContent = "";
  if ($("pw").value !== PASSWORD) {
    $("lockMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
    return;
  }
  $("lock").style.display = "none";
  $("app").style.display = "block";
  setLoading(false, "ëŒ€ê¸°");
};
$("pw").addEventListener("keydown", e => {
  if (e.key === "Enter") $("enterBtn").click();
});

/* ===== Excel ì²˜ë¦¬ ===== */
let workbook, sheet, groupsMap = new Map();

function colToIdx(c){
  let n=0; c=String(c||"").toUpperCase().trim();
  if(!/^[A-Z]+$/.test(c)) return null;
  for(let i=0;i<c.length;i++) n=n*26+(c.charCodeAt(i)-64);
  return n;
}
function idxToCol(n){
  let s=""; while(n){let m=(n-1)%26; s=String.fromCharCode(65+m)+s; n=((n-1)/26)|0}
  return s;
}
function addr(c,r){ return idxToCol(c) + r; }

function validateInputs(){
  const month = $("month").value.trim();
  const hEnd = Number($("headerEnd").value);
  const dStart = Number($("dataStart").value);
  const cS = colToIdx($("colStart").value);
  const cE = colToIdx($("colEnd").value);

  const errs = [];
  if(!month) errs.push("ì›”ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
  if(!Number.isFinite(hEnd) || hEnd < 1) errs.push("ì–‘ì‹ ë í–‰ì´ ì´ìƒí•©ë‹ˆë‹¤.");
  if(!Number.isFinite(dStart) || dStart < 1) errs.push("ë°ì´í„° ì‹œì‘ í–‰ì´ ì´ìƒí•©ë‹ˆë‹¤.");
  if(Number.isFinite(hEnd) && Number.isFinite(dStart) && hEnd >= dStart) errs.push("ì–‘ì‹ ë í–‰ì€ ë°ì´í„° ì‹œì‘ í–‰ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.");
  if(!cS) errs.push("ì—´ ì‹œì‘ì´ ì´ìƒí•©ë‹ˆë‹¤. ì˜ˆ: A");
  if(!cE) errs.push("ì—´ ëì´ ì´ìƒí•©ë‹ˆë‹¤. ì˜ˆ: CD");
  if(cS && cE && cS > cE) errs.push("ì—´ ì‹œì‘ì´ ì—´ ëë³´ë‹¤ ë’¤ì…ë‹ˆë‹¤.");

  return { month, hEnd, dStart, cS, cE, errs };
}

function renderLoadingGroups(text){
  $("groups").innerHTML = `
    <div class="loaderWrap">
      <div class="spinner"></div>
      <div class="muted">${text || "ë¡œë”©ì¤‘..."}</div>
    </div>
  `;
}

function renderGroups(){
  const root = $("groups");
  root.innerHTML = "";
  const keys = [...groupsMap.keys()].sort((a,b)=>String(a).localeCompare(String(b),"ko"));
  keys.forEach(g=>{
    const safe = encodeURIComponent(g);
    const div = document.createElement("div");
    div.className = "gitem";
    div.innerHTML = `<input type="checkbox" checked data-g="${safe}"/><span>${g}</span>`;
    root.appendChild(div);
  });
  $("groupCount").textContent = `ê·¸ë£¹ ${keys.length}ê°œ`;
}

$("file").onchange = () => {
  const ok = !!$("file").files[0];
  $("scanBtn").disabled = !ok;
  $("zipBtn").disabled = true;
  $("allOn").disabled = true;
  $("allOff").disabled = true;
  $("groupCount").textContent = "ì—…ë¡œë“œ í›„ ê·¸ë£¹ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.";
  $("groups").innerHTML = "";
  showMsg("");
  workbook = null; sheet = null; groupsMap = new Map();
};

$("allOn").onclick = ()=>document.querySelectorAll("#groups input[type=checkbox]").forEach(x=>x.checked=true);
$("allOff").onclick = ()=>document.querySelectorAll("#groups input[type=checkbox]").forEach(x=>x.checked=false);

$("scanBtn").onclick = async () => {
  if (typeof XLSX === "undefined") { showMsg("XLSX ë¡œë“œ ì‹¤íŒ¨ì…ë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", true); return; }

  const f = $("file").files[0];
  if(!f) return;

  const v = validateInputs();
  if(v.errs.length){ showMsg(v.errs.join(" "), true); return; }

  try{
    setLoading(true, "ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘");
    $("scanBtn").disabled = true;
    $("zipBtn").disabled = true;
    $("allOn").disabled = true;
    $("allOff").disabled = true;
    renderLoadingGroups("ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

    const ab = await f.arrayBuffer();
    workbook = XLSX.read(ab, {type:"array", cellStyles:true, cellNF:true, cellText:false});
    sheet = workbook.Sheets[FIXED_SHEET];
    if(!sheet){
      renderLoadingGroups("");
      showMsg(`'${FIXED_SHEET}' ì‹œíŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`, true);
      setLoading(false, "ì˜¤ë¥˜");
      return;
    }

    groupsMap.clear();
    const gcol = colToIdx(GROUP_COL);
    const range = XLSX.utils.decode_range(sheet["!ref"]);
    for(let r=v.dStart; r<=range.e.r+1; r++){
      const cell = sheet[addr(gcol, r)];
      const gv = cell ? String(cell.v ?? "").trim() : "";
      if(!gv) continue;
      if(!groupsMap.has(gv)) groupsMap.set(gv, []);
      groupsMap.get(gv).push(r);
    }

    renderGroups();
    const has = groupsMap.size > 0;
    $("zipBtn").disabled = !has;
    $("allOn").disabled = !has;
    $("allOff").disabled = !has;

    showMsg(has ? `<span class="ok">ê·¸ë£¹ ë¡œë“œ ì™„ë£Œ. í•„ìš”í•œ ê·¸ë£¹ë§Œ ì²´í¬í•˜ê³  ZIP ìƒì„± ëˆ„ë¥´ë©´ ë©ë‹ˆë‹¤.</span>`
                : `<span class="err">ë°ì´í„° ì‹œì‘ í–‰ë¶€í„° ê·¸ë£¹(Bì—´)ì´ í•œ ê±´ë„ ì—†ìŠµë‹ˆë‹¤.</span>`, !has);

    setLoading(false, has ? "ëŒ€ê¸°" : "ì˜¤ë¥˜");
  }catch(e){
    console.error(e);
    renderLoadingGroups("");
    showMsg("ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)", true);
    setLoading(false, "ì˜¤ë¥˜");
  }finally{
    $("scanBtn").disabled = false;
  }
};

function safeFilePart(s){
  return String(s ?? "").trim()
    .replace(/[\\\/:*?"<>|]/g, "_")
    .replace(/\s+/g, " ")
    .trim() || "ê·¸ë£¹ì—†ìŒ";
}

function copyCell(src, dst, sAddr, dAddr){
  const c = src[sAddr];
  if(!c) return;
  dst[dAddr] = {...c};
}

$("zipBtn").onclick = async () => {
  if (typeof XLSX === "undefined" || typeof JSZip === "undefined") {
    showMsg("ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨ì…ë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", true);
    return;
  }

  const v = validateInputs();
  if(v.errs.length){ showMsg(v.errs.join(" "), true); return; }
  if(!sheet || groupsMap.size === 0){ showMsg("ë¨¼ì € ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.", true); return; }

  const selected = [...document.querySelectorAll("#groups input[type=checkbox]:checked")]
    .map(cb => decodeURIComponent(cb.dataset.g));

  if(selected.length === 0){ showMsg("ì„ íƒëœ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.", true); return; }

  try{
    setLoading(true, "ZIP ìƒì„± ì¤‘");
    $("zipBtn").disabled = true;

    const zip = new JSZip();

    for(let i=0;i<selected.length;i++){
      const g = selected[i];
      const rows = groupsMap.get(g) || [];
      const out = {};

      // 1) ì–‘ì‹(1~hEnd) ë³µì‚¬
      for(let r=1; r<=v.hEnd; r++){
        for(let c=v.cS; c<=v.cE; c++){
          copyCell(sheet, out, addr(c,r), addr(c - v.cS + 1, r));
        }
      }

      // 2) ë°ì´í„°(ê·¸ë£¹ í–‰) ë³µì‚¬ -> dataStartë¶€í„° ì—°ì†
      let rr = v.dStart;
      for(const sr of rows){
        for(let c=v.cS; c<=v.cE; c++){
          copyCell(sheet, out, addr(c,sr), addr(c - v.cS + 1, rr));
        }
        rr++;
      }

      // ë²”ìœ„ ì„¤ì •
      const lastRow = Math.max(v.hEnd, rr-1);
      out["!ref"] = XLSX.utils.encode_range({ s:{c:0,r:0}, e:{c:(v.cE - v.cS), r:(lastRow-1)} });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, out, FIXED_SHEET);

      const fname = `${v.month} (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_${safeFilePart(g)}.xlsx`;
      const bytes = XLSX.write(wb, {type:"array", bookType:"xlsx"});
      zip.file(fname, bytes);

      $("status").textContent = `ZIP ìƒì„± ì¤‘ (${i+1}/${selected.length})`;
    }

    const blob = await zip.generateAsync({type:"blob"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${v.month} (ì£¼)ìˆ˜ì„ë„¤íŠ¸ì›ìŠ¤_ì •ì‚°ì„œ.zip`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);

    showMsg(`<span class="ok">ZIP ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ëìŠµë‹ˆë‹¤.</span>`);
    setLoading(false, "ì™„ë£Œ");
  }catch(e){
    console.error(e);
    showMsg("ZIP ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)", true);
    setLoading(false, "ì˜¤ë¥˜");
  }finally{
    $("zipBtn").disabled = false;
  }
};
</script>
</body>
</html>
